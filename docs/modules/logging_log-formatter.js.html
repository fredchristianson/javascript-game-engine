<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: logging/log-formatter.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: logging/log-formatter.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** 
 *  @fileOverview These classes converts a LogMessage into the format 
 * a LogWriter outputs.  It includes implementations
 *
 * - DefaultFormatter to output a string 
 * - HTMLFormatter to create a &lt;div> with &lt;spans> for each component
 * - JSONFormatter to create a JSON object
 */

import { LogMessage } from './log-message.js';
import { ASSERT } from '../assert.js';
import { STRING, TYPE } from '../helpers.js';
import { LOGLEVELS } from './log-level.js';

/**
 * @module Logging
 * @private
 */


/*
 * formatterId is used to cache formatted messages.
 * multiple writers may use the same formatter and shouldn't
 * each need to format .
 */
let nextFormatterId = 1;

/**
 * Base class to format part of a log message (time, date, module, etc)
 */
class FormatComponent {
    /**
     * 
     * @param {*} minLength pad with spaces if length is less than this
     * @param {*} maxLength truncate to this length
     */
    constructor(minLength = 0, maxLength = 250) {
        this._minLength = minLength;
        this._maxLength = maxLength;
    }

    get MinLength() {
        return this._minLength;
    }
    get MaxLength() {
        return this._maxLength;
    }

    set MinLength(len) {
        this._minLength = len;
    }
    set MaxLength(len) {
        this._maxLength = len;
    }

    /**
     * pad or truncate the text to be in the allowed range
     *
     * @param {String} messageComponent - the part of the message to pad/truncate
     * @returns {String}
     */
    _fixLength(messageComponent) {
        if (messageComponent.length &lt; this._minLength) {
            return messageComponent + ' '.repeat(this._minLength - messageComponent.length);
        } else if (messageComponent.length > this._maxLength) {
            return messageComponent.substring(0, this._maxLength);
        }
        return messageComponent;
    }

    /**
     * Format a component.  Derived classes must implement _format();
     *
     * @param {LogMessage} logMessage the message to formate. 
     * @returns {String}
     */
    format(logMessage) {
        return this._fixLength(this._format(logMessage));
    }

    /**
     * derived classes override this to write the component.
     *
     * @param {*} _logMessage - the entire LogMessage.  Components use the part(s) they need
     */
    _format(_logMessage) {
        throw new Error('derived class must implement _format(logMessage)');
    }
}

/**
 * Format LogMessage.Time  as a date
 *
 * @extends {FormatComponent}
 */
class DateFormatComponent extends FormatComponent {
    constructor() {
        super(11, 11); // always 11 characters (min&amp;max)
    }
    _format(logMessage) {
        return logMessage.Time.toLocaleDateString();
    }
}

/**
 * Format LogMessage.Time  as a time
 *
 * @extends {FormatComponent}
 */
class TimeFormatComponent extends FormatComponent {
    constructor() {
        super(10, 15); // 10-15 characters
    }
    _format(logMessage) {
        return logMessage.Time.toLocaleTimeString();
    }
}

/**
 * Format the module name.  The minimum with changes to match the longest
 * module name seen.
 *
 * @extends {FormatComponent}
 */
class ModuleNameFormatComponent extends FormatComponent {
    constructor() {
        super(10, 30);
    }
    _format(logMessage) {
        return logMessage.ModuleName;
    }
}


/**
 * write the descriptive name of the Level ("DEBUG","WARN",etc)
 *
 * @extends {FormatComponent}
 */
class LevelFormatComponent extends FormatComponent {
    constructor() {
        super();
    }

    _format(logMessage) {
        const len = logMessage.Level.Name.length;
        if (len > this.MinLength) {
            this.MinLength = len;
        }
        return logMessage.Level.Name;
    }
}

/**
 * Format the message parts of the LogMessage.  This is an 
 * array of objects.  They are all converted to strings then joined.
 *
 */
class TextFormatComponent extends FormatComponent {
    constructor() {
        super();
    }
    _format(logMessage) {
        const parts = logMessage.Parts;
        const text = parts
            .filter((part) => {
                return !TYPE.isType(part, Error);
            })
            .map(STRING.toString)
            .join(' ');
        return text;
    }


}

/**
 * A constant string value inserted into the formatted message.  Usually a separator (":","|",etc)
 *
 */
class StringFormatComponent extends FormatComponent {
    constructor(value) {
        super();
        this._text = value;
    }
    _format(_logMessage) {
        return this._text;
    }
}

/**
 * The base class to format a LogMessage.  The result may be a displayable 
 * string, or JSON, or anything else.
 *
 */
class LogFormatter {
    /**
     * Creates an instance of LogFormatter.
     *
     * @constructor
     * @param {Array&lt;FormatComponent>} [components=null] an optional array of components 
     * that are used in the formatted message.
     */
    constructor(components = null) {
        this._id = nextFormatterId++;
        this._components = components ?? [];
    }

    get ID() {
        return this._id;
    }

    /**
     * Handles all of the common functionality of formatting a message.  
     * Formatted messages are cached, so foratting is not run twice
     * if multiple LogWriters use the same LogFormatter.
     *
     * @param {LogMessage} logMessage the LogMessage to formate
     * @returns {*}
     */
    format(logMessage) {
        ASSERT.isType(logMessage, LogMessage);
        let formattedMessage = logMessage.getFormatByFormatID(this._id);
        if (STRING.isEmpty(formattedMessage)) {
            formattedMessage = this._format(logMessage);
            logMessage.setFormattedMessage(this._id, formattedMessage);
        }
        if (logMessage.StackTrace != null) {
            return `${formattedMessage}\n${logMessage.StackTrace}`;
        }
        return formattedMessage;
    }

    _format(logMessage) {
        const parts = this._components
            .map((component) => {
                return component.format(logMessage);
            });
        return parts.join('');
    }

}

/**
 * A default log message format
 *  DATE TIME - LEVEL: MODULE: message
 *
 * @extends {LogFormatter}
 */
class DefaultFormatter extends LogFormatter {
    constructor() {
        super([new DateFormatComponent(),
        new TimeFormatComponent(),
        new StringFormatComponent(' - '),
        new LevelFormatComponent(),
        new StringFormatComponent(' : '),
        new ModuleNameFormatComponent(),
        new StringFormatComponent(' : '),
        new TextFormatComponent()]);
    }
}

/**
 * Creates a JSON object of the message parts
 *
 * @extends {LogFormatter}
 */
class JSONFormatter extends LogFormatter {
    constructor() {
        super();
        this._textFormatter = new TextFormatComponent(0, 1000);
    }
    format(logMessage) {
        return {
            time: logMessage.Time.toISOString(),
            level: { name: logMessage.Level.Name, value: logMessage.Level.Value },
            moduleName: logMessage.ModuleName,
            message: this._textFormatter.format(logMessage),
            stack: logMessage.StackTrace
        };
    }

    parse(jsonMessage) {
        return new LogMessage(jsonMessage.moduleName,
            LOGLEVELS.get(jsonMessage.level.name),
            jsonMessage.message, new Date(jsonMessage.time), jsonMessage.stack);
    }
}

/**
 * Format the message to be inserted into a DOM element.  The result is a div HTMLElement
 * with a span for each component.
 *
 * @extends {LogFormatter}
 */
class HTMLFormatter extends LogFormatter {
    constructor() {
        super();
        this._timeFormatter = new TimeFormatComponent();
        this._dateFormatter = new DateFormatComponent();
        this._levelFormatter = new LevelFormatComponent();
        this._moduleFormatter = new ModuleNameFormatComponent();
        this._textFormatter = new TextFormatComponent();
    }
    format(logMessage) {
        const levelClass = ['log', `level-${logMessage.Level.Name.toLowerCase()}`];
        const element = this.createElement(null, 'div', levelClass, null);
        this.createElement(element, 'span', 'time', this._timeFormatter.format(logMessage));
        this.createElement(element, 'span', 'date', this._dateFormatter.format(logMessage));
        this.createElement(element, 'span', 'level', this._levelFormatter.format(logMessage));
        this.createElement(element, 'span', 'module', this._moduleFormatter.format(logMessage));
        let text = this._textFormatter.format(logMessage);
        const stack = logMessage.StackTrace;
        if (!STRING.isEmpty(stack)) {
            text += `\n${stack}`;
        }
        this.createElement(element, 'span', 'message', text);

        return element;
    }

    createElement(parent, tag, classList, text) {
        const element = document.createElement(tag);
        if (STRING.isString(classList)) {
            element.classList.add(classList);
        } else if (Array.isArray(classList)) {
            element.classList.add(...classList);
        }
        if (STRING.isString(text)) {
            element.innerText = text;
        }
        if (parent != null) {
            parent.appendChild(element);
        }
        return element;
    }
}

const DEFAULT_FORMATTER = new DefaultFormatter();

export {
    LogFormatter,
    DefaultFormatter,
    JSONFormatter,
    HTMLFormatter,
    FormatComponent,
    DateFormatComponent,
    TimeFormatComponent,
    ModuleNameFormatComponent,
    LevelFormatComponent,
    TextFormatComponent,
    StringFormatComponent,
    DEFAULT_FORMATTER

};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ASSERT.html">ASSERT</a></li><li><a href="module-Env.html">Env</a></li><li><a href="module-Helpers.html">Helpers</a></li><li><a href="module-Logging.html">Logging</a></li><li><a href="module-Net.html">Net</a></li><li><a href="module-Observe.html">Observe</a></li></ul><h3>Namespaces</h3><ul><li><a href="API.html">API</a></li><li><a href="ASSERT.html">ASSERT</a></li><li><a href="BOOLEAN.html">BOOLEAN</a></li><li><a href="ENSURE.html">ENSURE</a></li><li><a href="FUNCTION.html">FUNCTION</a></li><li><a href="LOGENV.html">LOGENV</a></li><li><a href="NUMBER.html">NUMBER</a></li><li><a href="OBJECT.html">OBJECT</a></li><li><a href="STRING.html">STRING</a></li><li><a href="TYPE.html">TYPE</a></li><li><a href="UTIL.html">UTIL</a></li><li><a href="module-Logging-LOGLEVELS.html">LOGLEVELS</a></li></ul><h3>Classes</h3><ul><li><a href="APIException.html">APIException</a></li><li><a href="ApiException_.html">ApiException</a></li><li><a href="ArgumentException.html">ArgumentException</a></li><li><a href="AssertionException.html">AssertionException</a></li><li><a href="Environment.html">Environment</a></li><li><a href="JsonResourceProperties.html">JsonResourceProperties</a></li><li><a href="Observable.html">Observable</a></li><li><a href="Observer.html">Observer</a></li><li><a href="PropertySource.html">PropertySource</a></li><li><a href="QueryStringProperties.html">QueryStringProperties</a></li><li><a href="ResourceManagerImpl.html">ResourceManagerImpl</a></li><li><a href="module-Logging-ApiWriter.html">ApiWriter</a></li><li><a href="module-Logging-ConsoleWriter.html">ConsoleWriter</a></li><li><a href="module-Logging-DateFormatComponent.html">DateFormatComponent</a></li><li><a href="module-Logging-DefaultFormatter.html">DefaultFormatter</a></li><li><a href="module-Logging-FormatComponent.html">FormatComponent</a></li><li><a href="module-Logging-HTMLFormatter.html">HTMLFormatter</a></li><li><a href="module-Logging-JSONFormatter.html">JSONFormatter</a></li><li><a href="module-Logging-LevelFormatComponent.html">LevelFormatComponent</a></li><li><a href="module-Logging-LogFormatter.html">LogFormatter</a></li><li><a href="module-Logging-LogWriter.html">LogWriter</a></li><li><a href="module-Logging-Logger.html">Logger</a></li><li><a href="module-Logging-ModuleNameFormatComponent.html">ModuleNameFormatComponent</a></li><li><a href="module-Logging-StringFormatComponent.html">StringFormatComponent</a></li><li><a href="module-Logging-TextFormatComponent.html">TextFormatComponent</a></li><li><a href="module-Logging-TimeFormatComponent.html">TimeFormatComponent</a></li><li><a href="module-Logging-WindowWriter.html">WindowWriter</a></li><li><a href="module-Net-ResourceManager.html">ResourceManager</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Mon Mar 20 2023 09:10:56 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
